package com.example.infobuscopy.presentation.screens

import android.util.Log
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.infobuscopy.data.model.BusRouteModel
import com.example.infobuscopy.data.repository.MainRepository
import com.google.android.gms.maps.model.LatLng
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.launch

data class MainState(
    val routes: List<BusRouteModel>,
    val polyLines: List<LatLng>,
)

class MainViewModel(
    private val repository: MainRepository,
) : ViewModel() {

    val mainState = MutableStateFlow(MainState(emptyList(), emptyList()))
    val error = MutableStateFlow<Boolean>(false)

    init {
        Log.e(TAG, "repository : $repository ")
        get14BusRoutes()
    }

    fun get14BusRoutes() {
        viewModelScope.launch(Dispatchers.IO) {
            while (true) {
                val routes =  repository.get14BusRoutes()
                Log.e(TAG, "get14BusRoutes: routes - $routes", )
                if(routes != null){
                    routes.filter { busRouteModel ->
                        !busRouteModel.offline
                    }.let { busRouteModelList ->
                        mainState.value = mainState.value.copy(routes = busRouteModelList, polyLines = get14Polyline())
                        error.value = false
                    }
                } else{
                    error.value = true
                }
                delay(5000)
                error.value = false
            }
        }
    }

    private fun get14Polyline(): List<LatLng> {
        return listOf<LatLng>(
            LatLng(69.13374, 54.90936),
            LatLng(69.13352, 54.90941),
            LatLng(69.13312, 54.90932),
            LatLng(69.13319, 54.90868),
            LatLng(69.13324, 54.90794),
            LatLng(69.13331, 54.90739),
            LatLng(69.13341, 54.90687),
            LatLng(69.13455, 54.90683),
            LatLng(69.13455, 54.90683),
            LatLng(69.13967, 54.90663),
            LatLng(69.13967, 54.90663),
            LatLng(69.14339, 54.90646),
            LatLng(69.14392, 54.90643),
            LatLng(69.14385, 54.90605),
            LatLng(69.14380, 54.90571),
            LatLng(69.14352, 54.90407),
            LatLng(69.14342, 54.90347),
            LatLng(69.14342, 54.90347),
            LatLng(69.14326, 54.90238),
            LatLng(69.14298, 54.90216),
            LatLng(69.14293, 54.90183),
            LatLng(69.14293, 54.90183),
            LatLng(69.14257, 54.89938),
            LatLng(69.14257, 54.89938),
            LatLng(69.14209, 54.89544),
            LatLng(69.14202, 54.89481),
            LatLng(69.14202, 54.89481),
            LatLng(69.14162, 54.89159),
            LatLng(69.14162, 54.89159),
            LatLng(69.14149, 54.89053),
            LatLng(69.14147, 54.89032),
            LatLng(69.14170, 54.89031),
            LatLng(69.14329, 54.89021),
            LatLng(69.14564, 54.89015),
            LatLng(69.14625, 54.89013),
            LatLng(69.14625, 54.89013),
            LatLng(69.15064, 54.89001),
            LatLng(69.15064, 54.89001),
            LatLng(69.15197, 54.88997),
            LatLng(69.15199, 54.88921),
            LatLng(69.15200, 54.88903),
            LatLng(69.15193, 54.88849),
            LatLng(69.15190, 54.88817),
            LatLng(69.15190, 54.88817),
            LatLng(69.15177, 54.88721),
            LatLng(69.15165, 54.88641),
            LatLng(69.15153, 54.88587),
            LatLng(69.15130, 54.88485),
            LatLng(69.15117, 54.88375),
            LatLng(69.15098, 54.88265),
            LatLng(69.15098, 54.88265),
            LatLng(69.15093, 54.88225),
            LatLng(69.15073, 54.88069),
            LatLng(69.15067, 54.88010),
            LatLng(69.15043, 54.87922),
            LatLng(69.15043, 54.87922),
            LatLng(69.15030, 54.87844),
            LatLng(69.15025, 54.87792),
            LatLng(69.15013, 54.87673),
            LatLng(69.15016, 54.87650),
            LatLng(69.15016, 54.87650),
            LatLng(69.15044, 54.87508),
            LatLng(69.15058, 54.87437),
            LatLng(69.15066, 54.87395),
            LatLng(69.15066, 54.87374),
            LatLng(69.15056, 54.87345),
            LatLng(69.15042, 54.87331),
            LatLng(69.15021, 54.87315),
            LatLng(69.15000, 54.87302),
            LatLng(69.14891, 54.87241),
            LatLng(69.14764, 54.87176),
            LatLng(69.14764, 54.87176),
            LatLng(69.14573, 54.87080),
            LatLng(69.14422, 54.87000),
            LatLng(69.14229, 54.86898),
            LatLng(69.14229, 54.86898),
            LatLng(69.13621, 54.86574),
            LatLng(69.13621, 54.86574),
            LatLng(69.13475, 54.86493),
            LatLng(69.13378, 54.86440),
            LatLng(69.13231, 54.86361),
            LatLng(69.13231, 54.86361),
            LatLng(69.12855, 54.86162),
            LatLng(69.12855, 54.86162),
            LatLng(69.12601, 54.86028),
            LatLng(69.12421, 54.85935),
            LatLng(69.12283, 54.85861),
            LatLng(69.12154, 54.85789),
            LatLng(69.12154, 54.85789),
            LatLng(69.12060, 54.85739),
            LatLng(69.11876, 54.85633),
            LatLng(69.11699, 54.85539),
            LatLng(69.11686, 54.85537),
            LatLng(69.11669, 54.85528),
            LatLng(69.11669, 54.85528),
            LatLng(69.11572, 54.85476),
            LatLng(69.11393, 54.85379),
            LatLng(69.11245, 54.85299),
            LatLng(69.11199, 54.85274),
            LatLng(69.11199, 54.85274),
            LatLng(69.11099, 54.85222),
            LatLng(69.11042, 54.85192),
            LatLng(69.10942, 54.85145),
            LatLng(69.10792, 54.85063),
            LatLng(69.10786, 54.85060),
            LatLng(69.10642, 54.84983),
            LatLng(69.10602, 54.84956),
            LatLng(69.10574, 54.84927),
            LatLng(69.10559, 54.84905),
            LatLng(69.10554, 54.84883),
            LatLng(69.10553, 54.84852),
            LatLng(69.10556, 54.84830),
            LatLng(69.10566, 54.84799),
            LatLng(69.10575, 54.84786),
            LatLng(69.10592, 54.84768),
            LatLng(69.10604, 54.84756),
            LatLng(69.10684, 54.84665),
            LatLng(69.10707, 54.84643),
            LatLng(69.10722, 54.84633),
            LatLng(69.10756, 54.84609),
            LatLng(69.10781, 54.84594),
            LatLng(69.10849, 54.84563),
            LatLng(69.11274, 54.84409),
            LatLng(69.11274, 54.84409),
            LatLng(69.11638, 54.84277),
            LatLng(69.11647, 54.84249),
            LatLng(69.11653, 54.84241),
            LatLng(69.11660, 54.84238),
            LatLng(69.11660, 54.84238),
            LatLng(69.11680, 54.84235),
            LatLng(69.11694, 54.84237),
            LatLng(69.11721, 54.84247),
            LatLng(69.11818, 54.84210),
            LatLng(69.11866, 54.84187),
            LatLng(69.11909, 54.84161),
            LatLng(69.11961, 54.84117),
            LatLng(69.11979, 54.84095),
            LatLng(69.12004, 54.84045),
            LatLng(69.12115, 54.83759),
            LatLng(69.12182, 54.83569),
            LatLng(69.12194, 54.83529),
            LatLng(69.12213, 54.83426),
            LatLng(69.12235, 54.83270),
            LatLng(69.12242, 54.83196),
            LatLng(69.12242, 54.83196),
            LatLng(69.12251, 54.83103),
            LatLng(69.12247, 54.83095),
            LatLng(69.12249, 54.83033),
            LatLng(69.12250, 54.83005),
            LatLng(69.12248, 54.82994),
            LatLng(69.12242, 54.82979),
            LatLng(69.12222, 54.82962),
            LatLng(69.12194, 54.82956),
            LatLng(69.12170, 54.82946),
            LatLng(69.11997, 54.82908),
            LatLng(69.11765, 54.82855),
            LatLng(69.11242, 54.82734),
            LatLng(69.11173, 54.82716),
            LatLng(69.11155, 54.82709),
            LatLng(69.11144, 54.82702),
            LatLng(69.11134, 54.82691),
            LatLng(69.11125, 54.82674),
            LatLng(69.11086, 54.82604),
            LatLng(69.10998, 54.82442),
            LatLng(69.10936, 54.82330),
            LatLng(69.10901, 54.82286),
            LatLng(69.10888, 54.82272),
            LatLng(69.10855, 54.82255),
            LatLng(69.10844, 54.82252),
            LatLng(69.10813, 54.82247),
            LatLng(69.10769, 54.82252),
            LatLng(69.10714, 54.82267),
            LatLng(69.10513, 54.82327),
            LatLng(69.10456, 54.82344),
            LatLng(69.10415, 54.82353),
            LatLng(69.10395, 54.82355),
            LatLng(69.10378, 54.82353),
            LatLng(69.10362, 54.82349),
            LatLng(69.10353, 54.82346),
            LatLng(69.10341, 54.82335),
            LatLng(69.10329, 54.82316),
            LatLng(69.10313, 54.82275),
            LatLng(69.10262, 54.82148),
            LatLng(69.10178, 54.81943),
            LatLng(69.10106, 54.81763),
            LatLng(69.10083, 54.81703),
            LatLng(69.10063, 54.81660),
            LatLng(69.10048, 54.81634),
            LatLng(69.10027, 54.81611),
            LatLng(69.09985, 54.81587),
            LatLng(69.09915, 54.81562),
            LatLng(69.09775, 54.81526),
            LatLng(69.09162, 54.81373),
            LatLng(69.09052, 54.81565),
            LatLng(69.09052, 54.81565),
            LatLng(69.08930, 54.81786),
            LatLng(69.08930, 54.81786),
            LatLng(69.08904, 54.81836),
            LatLng(69.08805, 54.82059),
            LatLng(69.08805, 54.82059),
            LatLng(69.08911, 54.81820),
            LatLng(69.08911, 54.81820),
            LatLng(69.09068, 54.81537),
            LatLng(69.09068, 54.81537),
            LatLng(69.09162, 54.81373),
            LatLng(69.09775, 54.81526),
            LatLng(69.09915, 54.81562),
            LatLng(69.09985, 54.81587),
            LatLng(69.10027, 54.81611),
            LatLng(69.10048, 54.81634),
            LatLng(69.10063, 54.81660),
            LatLng(69.10083, 54.81703),
            LatLng(69.10106, 54.81763),
            LatLng(69.10178, 54.81943),
            LatLng(69.10262, 54.82148),
            LatLng(69.10313, 54.82275),
            LatLng(69.10329, 54.82316),
            LatLng(69.10341, 54.82335),
            LatLng(69.10353, 54.82346),
            LatLng(69.10362, 54.82349),
            LatLng(69.10378, 54.82353),
            LatLng(69.10395, 54.82355),
            LatLng(69.10415, 54.82353),
            LatLng(69.10456, 54.82344),
            LatLng(69.10513, 54.82327),
            LatLng(69.10714, 54.82267),
            LatLng(69.10769, 54.82252),
            LatLng(69.10813, 54.82247),
            LatLng(69.10844, 54.82252),
            LatLng(69.10855, 54.82255),
            LatLng(69.10888, 54.82272),
            LatLng(69.10901, 54.82286),
            LatLng(69.10936, 54.82330),
            LatLng(69.10998, 54.82442),
            LatLng(69.11086, 54.82604),
            LatLng(69.11125, 54.82674),
            LatLng(69.11134, 54.82691),
            LatLng(69.11144, 54.82702),
            LatLng(69.11155, 54.82709),
            LatLng(69.11173, 54.82716),
            LatLng(69.11242, 54.82734),
            LatLng(69.11765, 54.82855),
            LatLng(69.11997, 54.82908),
            LatLng(69.12170, 54.82946),
            LatLng(69.12202, 54.82945),
            LatLng(69.12220, 54.82938),
            LatLng(69.12226, 54.82931),
            LatLng(69.12229, 54.82919),
            LatLng(69.12220, 54.82881),
            LatLng(69.12222, 54.82876),
            LatLng(69.12228, 54.82872),
            LatLng(69.12224, 54.82852),
            LatLng(69.12232, 54.82833),
            LatLng(69.12239, 54.82826),
            LatLng(69.12250, 54.82820),
            LatLng(69.12263, 54.82818),
            LatLng(69.12277, 54.82819),
            LatLng(69.12287, 54.82822),
            LatLng(69.12295, 54.82827),
            LatLng(69.12298, 54.82831),
            LatLng(69.12299, 54.82854),
            LatLng(69.12302, 54.82868),
            LatLng(69.12294, 54.82940),
            LatLng(69.12292, 54.82965),
            LatLng(69.12292, 54.82965),
            LatLng(69.12282, 54.83042),
            LatLng(69.12237, 54.83373),
            LatLng(69.12224, 54.83463),
            LatLng(69.12212, 54.83531),
            LatLng(69.12197, 54.83575),
            LatLng(69.12162, 54.83676),
            LatLng(69.12128, 54.83763),
            LatLng(69.12019, 54.84051),
            LatLng(69.11991, 54.84098),
            LatLng(69.11964, 54.84131),
            LatLng(69.11931, 54.84160),
            LatLng(69.11920, 54.84168),
            LatLng(69.11877, 54.84194),
            LatLng(69.11835, 54.84215),
            LatLng(69.11732, 54.84255),
            LatLng(69.11681, 54.84274),
            LatLng(69.11681, 54.84274),
            LatLng(69.11239, 54.84435),
            LatLng(69.11239, 54.84435),
            LatLng(69.10948, 54.84538),
            LatLng(69.10830, 54.84583),
            LatLng(69.10798, 54.84598),
            LatLng(69.10767, 54.84615),
            LatLng(69.10736, 54.84637),
            LatLng(69.10717, 54.84652),
            LatLng(69.10692, 54.84677),
            LatLng(69.10622, 54.84761),
            LatLng(69.10612, 54.84773),
            LatLng(69.10588, 54.84804),
            LatLng(69.10578, 54.84823),
            LatLng(69.10578, 54.84831),
            LatLng(69.10582, 54.84841),
            LatLng(69.10604, 54.84860),
            LatLng(69.10630, 54.84880),
            LatLng(69.10636, 54.84892),
            LatLng(69.10637, 54.84899),
            LatLng(69.10633, 54.84913),
            LatLng(69.10621, 54.84942),
            LatLng(69.10620, 54.84954),
            LatLng(69.10624, 54.84972),
            LatLng(69.10642, 54.84983),
            LatLng(69.10786, 54.85060),
            LatLng(69.10792, 54.85063),
            LatLng(69.10942, 54.85145),
            LatLng(69.11042, 54.85192),
            LatLng(69.11099, 54.85222),
            LatLng(69.11099, 54.85222),
            LatLng(69.11319, 54.85338),
            LatLng(69.11412, 54.85390),
            LatLng(69.11412, 54.85390),
            LatLng(69.11686, 54.85537),
            LatLng(69.11699, 54.85539),
            LatLng(69.11789, 54.85586),
            LatLng(69.11789, 54.85586),
            LatLng(69.11876, 54.85633),
            LatLng(69.12060, 54.85739),
            LatLng(69.12160, 54.85792),
            LatLng(69.12160, 54.85792),
            LatLng(69.12238, 54.85836),
            LatLng(69.12366, 54.85906),
            LatLng(69.12620, 54.86038),
            LatLng(69.12658, 54.86058),
            LatLng(69.12658, 54.86058),
            LatLng(69.13163, 54.86325),
            LatLng(69.13163, 54.86325),
            LatLng(69.13438, 54.86472),
            LatLng(69.13438, 54.86472),
            LatLng(69.13526, 54.86522),
            LatLng(69.13737, 54.86636),
            LatLng(69.14188, 54.86877),
            LatLng(69.14235, 54.86900),
            LatLng(69.14229, 54.86896),
            LatLng(69.14292, 54.86932),
            LatLng(69.14407, 54.86993),
            LatLng(69.14513, 54.87049),
            LatLng(69.14673, 54.87130),
            LatLng(69.14673, 54.87130),
            LatLng(69.14907, 54.87249),
            LatLng(69.15021, 54.87315),
            LatLng(69.15056, 54.87345),
            LatLng(69.15066, 54.87374),
            LatLng(69.15066, 54.87395),
            LatLng(69.15048, 54.87487),
            LatLng(69.15035, 54.87553),
            LatLng(69.15035, 54.87553),
            LatLng(69.15016, 54.87652),
            LatLng(69.15013, 54.87673),
            LatLng(69.15021, 54.87747),
            LatLng(69.15030, 54.87844),
            LatLng(69.15043, 54.87922),
            LatLng(69.15052, 54.87957),
            LatLng(69.15056, 54.87971),
            LatLng(69.15056, 54.87971),
            LatLng(69.15068, 54.88013),
            LatLng(69.15080, 54.88130),
            LatLng(69.15093, 54.88231),
            LatLng(69.15109, 54.88325),
            LatLng(69.15110, 54.88331),
            LatLng(69.15110, 54.88331),
            LatLng(69.15125, 54.88454),
            LatLng(69.15130, 54.88485),
            LatLng(69.15146, 54.88556),
            LatLng(69.15163, 54.88635),
            LatLng(69.15169, 54.88667),
            LatLng(69.15184, 54.88769),
            LatLng(69.15187, 54.88795),
            LatLng(69.15187, 54.88795),
            LatLng(69.15200, 54.88903),
            LatLng(69.15197, 54.88997),
            LatLng(69.15104, 54.89000),
            LatLng(69.15104, 54.89000),
            LatLng(69.14434, 54.89018),
            LatLng(69.14434, 54.89018),
            LatLng(69.14329, 54.89021),
            LatLng(69.14170, 54.89031),
            LatLng(69.14185, 54.89152),
            LatLng(69.14192, 54.89200),
            LatLng(69.14192, 54.89200),
            LatLng(69.14213, 54.89337),
            LatLng(69.14221, 54.89417),
            LatLng(69.14221, 54.89417),
            LatLng(69.14239, 54.89562),
            LatLng(69.14263, 54.89721),
            LatLng(69.14288, 54.89933),
            LatLng(69.14288, 54.89933),
            LatLng(69.14295, 54.89982),
            LatLng(69.14309, 54.90094),
            LatLng(69.14320, 54.90172),
            LatLng(69.14320, 54.90170),
            LatLng(69.14327, 54.90216),
            LatLng(69.14326, 54.90238),
            LatLng(69.14332, 54.90276),
            LatLng(69.14338, 54.90318),
            LatLng(69.14352, 54.90407),
            LatLng(69.14352, 54.90407),
            LatLng(69.14354, 54.90420),
            LatLng(69.14377, 54.90554),
            LatLng(69.14392, 54.90643),
            LatLng(69.14264, 54.90649),
            LatLng(69.14264, 54.90649),
            LatLng(69.13647, 54.90676),
            LatLng(69.13647, 54.90676),
            LatLng(69.13341, 54.90687),
            LatLng(69.13331, 54.90739),
            LatLng(69.13324, 54.90794),
            LatLng(69.13319, 54.90868),
            LatLng(69.13314, 54.90915),
            LatLng(69.13359, 54.90917),
            LatLng(69.13374, 54.90926),
            LatLng(69.13375, 54.90936)
        ).map {
            LatLng(it.longitude, it.latitude)
        }
    }


    companion object {
        private const val TAG = "MainViewModel"
    }
}